<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID + Fingerprint Verification System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #ffffff;
            background: url('cyber-security-concept-digital-art(2).jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            border-radius: 15px;
            margin-bottom: 2rem;
            border: 1px solid rgba(2, 84, 216, 0.3);
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0254d8;
            text-shadow: 0 0 10px rgba(2, 84, 216, 0.3);
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-size: 14px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #0254d8, #0040a8);
            color: white;
            border: 2px solid #0254d8;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
            color: white;
            border: 2px solid #6c757d;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: 2px solid #dc3545;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .card {
            background: rgba(20, 20, 20, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(2, 84, 216, 0.2);
        }

        /* Registration and Login cards: white with dark text */
        #registrationPage.card,
        #loginPage.card {
            background: rgba(255, 255, 255, 0.95);
            color: #222;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            border: 1px solid #e1e8ed;
        }

        #registrationPage.card label,
        #registrationPage.card h2,
        #loginPage.card label,
        #loginPage.card h2 {
            color: #0254d8;
        }

        #registrationPage.card input,
        #registrationPage.card select,
        #loginPage.card input,
        #loginPage.card select {
            background-color: #f8f9fa;
            color: #222;
            border: 2px solid #e1e8ed;
        }

        #registrationPage.card input:focus,
        #registrationPage.card select:focus,
        #loginPage.card input:focus,
        #loginPage.card select:focus {
            border-color: #0254d8;
            box-shadow: 0 0 10px rgba(2, 84, 216, 0.1);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #ffffff;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #0254d8;
            box-shadow: 0 0 10px rgba(2, 84, 216, 0.3);
        }

        .hidden {
            display: none;
        }

        .role-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .role-card {
            background: linear-gradient(135deg, #0254d8, #003d9e);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            border: 2px solid rgba(2, 84, 216, 0.3);
        }

        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(2, 84, 216, 0.4);
        }

        .role-card.teacher {
            background: linear-gradient(135deg, #6c757d, #495057);
            border: 2px solid rgba(108, 117, 125, 0.3);
        }

        .fingerprint-status {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            font-weight: bold;
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #0254d8, #003d9e);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
        }

        .attendance-table th, .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
            color: #ffffff;
        }

        .attendance-table th {
            background-color: #0254d8;
            font-weight: bold;
        }

        .alert {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 10px;
            border-left: 5px solid;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background-color: rgba(212, 237, 218, 0.1);
            border-left-color: #28a745;
            color: #28a745;
        }

        .alert-error {
            background-color: rgba(248, 215, 218, 0.1);
            border-left-color: #dc3545;
            color: #dc3545;
        }

        .alert-info {
            background-color: rgba(217, 237, 247, 0.1);
            border-left-color: #17a2b8;
            color: #17a2b8;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-online {
            background-color: #28a745;
            color: white;
        }
        .connection-offline {
            background-color: #dc3545;
            color: white;
        }

        @media (max-width: 768px) {
            .role-selector {
                grid-template-columns: 1fr;
            }
            
            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status connection-offline">
        Connecting...
    </div>

    <nav class="nav">
        <div class="nav-content">
            <div class="logo">Smart Verification System</div>
            <div class="nav-buttons">
                <button class="btn btn-primary" onclick="showHome()">Home</button>
                <button class="btn btn-secondary" onclick="showLogin()">Login</button>
                <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display: none;">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Home Page -->
        <div id="homePage" class="card">
            <h1 style="color: #0254d8; text-align: center; margin-bottom: 1rem;">Welcome to Smart Verification System</h1>
            <p style="text-align: center; font-size: 1.1rem; margin-bottom: 2rem;">Secure RFID + Fingerprint Authentication System</p>
            
            <div class="role-selector">
                <div class="role-card" onclick="showRegistration('student')">
                    <h3>👨‍🎓 Student</h3>
                    <p>Register for campus access</p>
                </div>
                <div class="role-card teacher" onclick="showRegistration('teacher')">
                    <h3>👨‍🏫 Teacher/Lecturer</h3>
                    <p>Register and manage system</p>
                </div>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registrationPage" class="card hidden">
            <h2 id="registrationTitle" style="color: #0254d8; margin-bottom: 1.5rem;">Registration</h2>
            
            <form id="registrationForm">
                <input type="hidden" id="userRole" name="role">
                
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required>
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <!-- Student Fields -->
                <div id="studentFields" class="hidden">
                    <div class="form-group">
                        <label for="matricNumber">Matriculation Number</label>
                        <input type="text" id="matricNumber" name="matricNumber" placeholder="e.g., CSC/2024/001">
                    </div>

                    <div class="form-group">
                        <label for="faculty">Faculty</label>
                        <select id="faculty" name="faculty" onchange="updateDepartments()">
                            <option value="">Select Faculty</option>
                            <option value="technology">Technology</option>
                            <option value="science">Science</option>
                            <option value="arts">Arts</option>
                            <option value="health_sciences">Health Sciences</option>
                            <option value="pharmacy">Pharmacy</option>
                            <option value="law">Law</option>
                            <option value="social_sciences">Social Sciences</option>
                            <option value="education">Education</option>
                            <option value="computing">Computing</option>
                            <option value="agriculture">Agriculture</option>
                            <option value="environmental_design_and_management">Environmental Design and Management</option>
                            <option value="dentistry">Dentistry</option>
                            <option value="administration">Administration</option>
                            <option value="business">Business</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="department">Department</label>
                        <select id="department" name="department">
                            <option value="">Select Faculty First</option>
                        </select>
                    </div>
                </div>

                <!-- Teacher Fields -->
                <div id="teacherFields" class="hidden">
                    <div class="form-group">
                        <label for="staffId">Staff ID</label>
                        <input type="text" id="staffId" name="staffId" placeholder="e.g., STAFF001">
                    </div>

                    <div class="form-group">
                        <label for="designation">Designation</label>
                        <select id="designation" name="designation">
                            <option value="">Select Designation</option>
                            <option value="lecturer">Lecturer</option>
                            <option value="professor">Professor</option>
                        </select>
                    </div>
                </div>

                <!-- RFID Card -->
                <div class="form-group">
                    <label for="cardUID">RFID Card UID</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="cardUID" name="cardUID" placeholder="Click scan to get RFID card UID" readonly style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="scanRFID()">🏷️ Scan RFID</button>
                    </div>
                </div>

                <!-- Fingerprint -->
                <div class="form-group">
                    <label>Fingerprint Registration</label>
                    <div id="fingerprintStatus" class="fingerprint-status">
                        Ready to register fingerprint
                    </div>
                    <button type="button" class="btn btn-primary" id="fingerprintBtn" onclick="registerFingerprint()">👆 Register Fingerprint</button>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Complete Registration</button>
                    <button type="button" class="btn btn-secondary" onclick="showHome()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Login Page -->
        <div id="loginPage" class="card hidden">
            <h2 style="color: #0254d8; margin-bottom: 1.5rem;">Teacher/Lecturer Login</h2>
            
            <div style="margin-bottom: 2rem; padding: 15px; background-color: rgba(2, 84, 216, 0.1); border-radius: 10px; border-left: 4px solid #0254d8;">
                <h4 style="color: #0254d8; margin-bottom: 10px;">Sample Login Credentials:</h4>
                <p style="font-size: 14px; margin: 5px 0;"><strong>Email:</strong> john.smith@university.edu</p>
                <p style="font-size: 14px; margin: 5px 0;"><strong>Fingerprint:</strong> teacher_fingerprint_1</p>
                <p style="font-size: 14px; margin: 5px 0;"><strong>Or Email:</strong> sarah.johnson@university.edu</p>
                <p style="font-size: 14px; margin: 5px 0;"><strong>Fingerprint:</strong> teacher_fingerprint_2</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" name="email" required>
                </div>

                <div class="form-group">
                    <label>Fingerprint Authentication</label>
                    <div id="loginFingerprintStatus" class="fingerprint-status">
                        Ready for fingerprint authentication
                    </div>
                    <button type="button" class="btn btn-primary" id="loginFingerprintBtn" onclick="authenticateFingerprint()">👆 Authenticate</button>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Login</button>
                    <button type="button" class="btn btn-secondary" onclick="showHome()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacherDashboard" class="hidden">
            <div class="card">
                <h2 style="color: #0254d8; margin-bottom: 1.5rem;">Teacher Dashboard</h2>
                
                <div style="margin-bottom: 2rem;">
                    <h4 id="welcomeMessage" style="color: #0254d8;">Welcome!</h4>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div>Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayAttendance">0</div>
                        <div>Today's Attendance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAttendance">0</div>
                        <div>Total Records</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Recent Attendance Records</h3>
                    <button class="btn btn-secondary" onclick="loadDashboardData()" style="font-size: 12px;">🔄 Refresh</button>
                </div>
                
                <table class="attendance-table" id="attendanceTable">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Student Name</th>
                            <th>ID Number</th>
                            <th>Faculty</th>
                            <th>Department</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #666;">Loading attendance data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Include API Integration Script -->
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3050/api';
        let authToken = null;

        // API Helper Class
        class ApiClient {
            constructor() {
                this.baseURL = API_BASE_URL;
                this.token = authToken;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                    ...options,
                };

                if (this.token) {
                    config.headers['Authorization'] = `Bearer ${this.token}`;
                }

                if (options.body && typeof options.body === 'object') {
                    config.body = JSON.stringify(options.body);
                }

                try {
                    const response = await fetch(url, config);
                    let data;
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        data = { message: await response.text() };
                    }

                    if (!response.ok) {
                        throw new Error(data.error || data.message || `HTTP error! status: ${response.status}`);
                    }

                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('Unable to connect to server. Please ensure the backend is running on http://localhost:3050');
                    }
                    
                    throw error;
                }
            }

            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            async post(endpoint, data) {
                return this.request(endpoint, { 
                    method: 'POST', 
                    body: data 
                });
            }

            setToken(token) {
                this.token = token;
                authToken = token;
            }

            clearToken() {
                this.token = null;
                authToken = null;
            }
        }

        const api = new ApiClient();

        // Global variables
        let currentUser = null;
        let registeredFingerprint = false;
        let authenticatedFingerprint = false;
        let registeredFingerprintData = null;
        let authenticatedFingerprintData = null;

        // Department mappings by faculty
        const departmentsByFaculty = {
            technology: [
                'agricultural_engineering',
                'building',
                'chemical_engineering',
                'civil_engineering',
                'computer_engineering',
                'electrical/electronics_engineering',
                'engineering_physics',
                'mechanical_engineering',
                'metallurgical_and_material_engineering'
            ],
            science: [
                'applied_geophysics',
                'biochemistry',
                'chemistry',
                'geology',
                'industrial_chemistry',
                'mathematics',
                'microbiology',
                'physics',
                'statistics',
                'zoology'
            ],
            computing: [
                'computer_science',
                'computer_science_with_economics',
                'computer_science_with_mathematics',
                'computer_science_with_economics_mathematics'
            ],
            arts: [
                'english_language',
                'history',
                'philosophy',
                'religious_studies',
                'music',
                'drama/dramatic/performing_arts'
            ],
            health_sciences: [
                'medicine_and_surgery',
                'medical_rehabilitation',
                'nursing/nursing_science'
            ],
            law: ['law'],
            pharmacy: ['pharmacy'],
            social_sciences: [
                'economics',
                'political_science',
                'psychology',
                'sociology_and_anthropology',
                'geography'
            ],
            education: [
                'education_and_mathematics',
                'education_and_english_language',
                'education_and_biology',
                'physical_and_health_education'
            ],
            agriculture: [
                'crop_production_and_protection',
                'animal_science',
                'agricultural_economics',
                'food_science_and_technology'
            ],
            environmental_design_and_management: [
                'architecture',
                'urban_and_regional_planning',
                'estate_management',
                'quantity_surveying'
            ],
            dentistry: ['dentistry_and_dental_surgery'],
            administration: [
                'accounting',
                'public_administration',
                'local_government_studies'
            ],
            business: ['business_administration']
        };

        // Connection status management
        function updateConnectionStatus(isOnline) {
            const statusElement = document.getElementById('connectionStatus');
            if (isOnline) {
                statusElement.textContent = 'Backend Connected';
                statusElement.className = 'connection-status connection-online';
            } else {
                statusElement.textContent = 'Backend Offline';
                statusElement.className = 'connection-status connection-offline';
            }
        }

        // Backend connection test
        async function checkBackendConnection() {
            try {
                const response = await api.get('/health');
                console.log('Backend connected successfully:', response);
                updateConnectionStatus(true);
                return true;
            } catch (error) {
                console.error('Backend connection failed:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        async function testConnection() {
            const isConnected = await checkBackendConnection();
            if (isConnected) {
                showAlert('Backend connection successful!', 'success');
            } else {
                showAlert('Backend connection failed. Please ensure the server is running on http://localhost:3050', 'error');
            }
        }

        // Update departments based on selected faculty
        function updateDepartments() {
            const facultySelect = document.getElementById('faculty');
            const departmentSelect = document.getElementById('department');
            const selectedFaculty = facultySelect.value;

            departmentSelect.innerHTML = '<option value="">Select Department</option>';

            if (selectedFaculty && departmentsByFaculty[selectedFaculty]) {
                const departments = departmentsByFaculty[selectedFaculty];
                departments.forEach(department => {
                    const option = document.createElement('option');
                    option.value = department;
                    option.textContent = department.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    departmentSelect.appendChild(option);
                });
                departmentSelect.disabled = false;
            } else {
                departmentSelect.innerHTML = '<option value="">Select Faculty First</option>';
                departmentSelect.disabled = true;
            }
        }

        // Navigation functions
        function showHome() {
            hideAllPages();
            document.getElementById('homePage').classList.remove('hidden');
        }

        function showRegistration(role) {
            hideAllPages();
            document.getElementById('registrationPage').classList.remove('hidden');
            document.getElementById('userRole').value = role;
            document.getElementById('registrationTitle').textContent = 
                role === 'student' ? 'Student Registration' : 'Teacher Registration';
            
            registeredFingerprint = false;
            registeredFingerprintData = null;
            resetFingerprintStatus();
            
            if (role === 'student') {
                document.getElementById('studentFields').classList.remove('hidden');
                document.getElementById('teacherFields').classList.add('hidden');
                document.getElementById('matricNumber').required = true;
                document.getElementById('faculty').required = true;
                document.getElementById('department').required = true;
                document.getElementById('staffId').required = false;
                document.getElementById('designation').required = false;
            } else {
                document.getElementById('studentFields').classList.add('hidden');
                document.getElementById('teacherFields').classList.remove('hidden');
                document.getElementById('matricNumber').required = false;
                document.getElementById('faculty').required = false;
                document.getElementById('department').required = false;
                document.getElementById('staffId').required = true;
                document.getElementById('designation').required = true;
            }
            
            updateDepartments();
        }

        function showLogin() {
            hideAllPages();
            document.getElementById('loginPage').classList.remove('hidden');
            authenticatedFingerprint = false;
            authenticatedFingerprintData = null;
            resetLoginFingerprintStatus();
        }

        function showTeacherDashboard() {
            hideAllPages();
            document.getElementById('teacherDashboard').classList.remove('hidden');
            document.getElementById('logoutBtn').style.display = 'inline-block';
            
            if (currentUser) {
                document.getElementById('welcomeMessage').textContent = 
                    `Welcome, ${currentUser.fullName || currentUser.email}!`;
            }
            
            loadDashboardData();
        }

        function hideAllPages() {
            const pages = ['homePage', 'registrationPage', 'loginPage', 'teacherDashboard'];
            pages.forEach(pageId => {
                document.getElementById(pageId).classList.add('hidden');
            });
        }

        // RFID and Fingerprint functions
        async function scanRFID() {
            try {
                const response = await api.post('/simulate/rfid-scan');
                document.getElementById('cardUID').value = response.cardUID;
                showAlert('RFID Card scanned successfully!', 'success');
            } catch (error) {
                console.error('RFID scan error:', error);
                showAlert(error.message || 'RFID scan failed. Please try again.', 'error');
            }
        }

        function createFingerprintOverlay() {
            return new Promise((resolve, reject) => {
                let fingerDetected = false;
                let detectionTimeout;
                
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                `;
                
                const instruction = document.createElement('div');
                instruction.style.cssText = `
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
                    max-width: 450px;
                    margin: 20px;
                    color: #333;
                `;
                instruction.innerHTML = `
                    <div style="font-size: 64px; margin-bottom: 20px;">👆</div>
                    <h3 style="color: #0254d8; margin-bottom: 15px;">Place Your Finger</h3>
                    <p style="color: #666; margin-bottom: 20px;">Click anywhere on this area to simulate placing your finger on the fingerprint sensor</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 24px; color: #0254d8;">⏱️</div>
                        <div style="font-size: 14px; color: #666;">Timeout in 10 seconds</div>
                    </div>
                `;
                
                overlay.appendChild(instruction);
                document.body.appendChild(overlay);
                
                detectionTimeout = setTimeout(() => {
                    if (!fingerDetected) {
                        document.body.removeChild(overlay);
                        reject(new Error('No finger detected. Please try again.'));
                    }
                }, 10000);
                
                overlay.addEventListener('click', () => {
                    fingerDetected = true;
                    clearTimeout(detectionTimeout);
                    document.body.removeChild(overlay);
                    resolve();
                });
            });
        }

        async function registerFingerprint() {
            const statusElement = document.getElementById('fingerprintStatus');
            const buttonElement = document.getElementById('fingerprintBtn');
            
            try {
                statusElement.className = 'fingerprint-status status-processing';
                statusElement.textContent = 'Waiting... Please place your finger on the sensor now';
                buttonElement.disabled = true;
                buttonElement.textContent = 'Waiting for finger...';
                
                await createFingerprintOverlay();
                
                statusElement.textContent = 'Scanning fingerprint... Please hold still';
                
                const response = await api.post('/simulate/fingerprint-register');
                
                if (response.success) {
                    registeredFingerprint = true;
                    registeredFingerprintData = response.fingerprintData;
                    statusElement.className = 'fingerprint-status status-success';
                    statusElement.textContent = 'Fingerprint registered successfully!';
                    buttonElement.textContent = 'Fingerprint Registered ✓';
                    showAlert('Fingerprint registered successfully!', 'success');
                } else {
                    throw new Error(response.message || 'Registration failed');
                }
            } catch (error) {
                console.error('Fingerprint registration error:', error);
                registeredFingerprint = false;
                registeredFingerprintData = null;
                statusElement.className = 'fingerprint-status status-error';
                statusElement.textContent = 'Registration failed. Please try again.';
                buttonElement.disabled = false;
                buttonElement.textContent = 'Try Again';
                showAlert(error.message || 'Fingerprint registration failed. Please try again.', 'error');
            }
        }

        async function authenticateFingerprint() {
            const statusElement = document.getElementById('loginFingerprintStatus');
            const buttonElement = document.getElementById('loginFingerprintBtn');
            
            try {
                statusElement.className = 'fingerprint-status status-processing';
                statusElement.textContent = 'Waiting... Please place your finger on the sensor now';
                buttonElement.disabled = true;
                buttonElement.textContent = 'Waiting for finger...';
                
                await createFingerprintOverlay();
                
                statusElement.textContent = 'Authenticating fingerprint... Please hold still';
                
                const response = await api.post('/simulate/fingerprint-auth');
                
                if (response.success) {
                    authenticatedFingerprint = true;
                    authenticatedFingerprintData = response.fingerprintData;
                    statusElement.className = 'fingerprint-status status-success';
                    statusElement.textContent = 'Fingerprint authenticated successfully!';
                    buttonElement.textContent = 'Authenticated ✓';
                    showAlert('Fingerprint authenticated successfully!', 'success');
                } else {
                    throw new Error(response.message || 'Authentication failed');
                }
            } catch (error) {
                console.error('Fingerprint authentication error:', error);
                authenticatedFingerprint = false;
                authenticatedFingerprintData = null;
                statusElement.className = 'fingerprint-status status-error';
                statusElement.textContent = 'Authentication failed. Please try again.';
                buttonElement.disabled = false;
                buttonElement.textContent = 'Try Again';
                showAlert(error.message || 'Fingerprint authentication failed. Please try again.', 'error');
            }
        }

        function resetFingerprintStatus() {
            const statusElement = document.getElementById('fingerprintStatus');
            const buttonElement = document.getElementById('fingerprintBtn');
            statusElement.className = 'fingerprint-status';
            statusElement.textContent = 'Ready to register fingerprint';
            buttonElement.disabled = false;
            buttonElement.textContent = 'Register Fingerprint';
        }

        function resetLoginFingerprintStatus() {
            const statusElement = document.getElementById('loginFingerprintStatus');
            const buttonElement = document.getElementById('loginFingerprintBtn');
            statusElement.className = 'fingerprint-status';
            statusElement.textContent = 'Ready for fingerprint authentication';
            buttonElement.disabled = false;
            buttonElement.textContent = 'Authenticate';
        }

        // Form handlers
        async function handleRegistration(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                role: formData.get('role'),
                rfidCardUID: formData.get('cardUID'),
                fingerprintData: registeredFingerprintData
            };

            if (userData.role === 'student') {
                userData.matricNumber = formData.get('matricNumber');
                userData.faculty = formData.get('faculty');
                userData.department = formData.get('department');
            } else if (userData.role === 'teacher') {
                userData.staffId = formData.get('staffId');
                userData.designation = formData.get('designation');
            }

            if (!userData.rfidCardUID) {
                showAlert('Please scan your RFID card', 'error');
                return;
            }
            
            if (!registeredFingerprint || !registeredFingerprintData) {
                showAlert('Please register your fingerprint successfully', 'error');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';

            try {
                const response = await api.post('/register', userData);
                showAlert(response.message || 'Registration completed successfully!', 'success');
                
                e.target.reset();
                registeredFingerprint = false;
                registeredFingerprintData = null;
                resetFingerprintStatus();
                updateDepartments();
                
                setTimeout(() => {
                    showHome();
                }, 1500);
            } catch (error) {
                console.error('Registration error:', error);
                showAlert(error.message || 'Registration failed. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                showAlert('Please enter your email address', 'error');
                return;
            }
            
            if (!authenticatedFingerprint || !authenticatedFingerprintData) {
                showAlert('Please authenticate your fingerprint first', 'error');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            try {
                const response = await api.post('/login', {
                    email: email,
                    fingerprintData: authenticatedFingerprintData
                });

                api.setToken(response.token);
                currentUser = response.user;
                
                showTeacherDashboard();
                showAlert(response.message || 'Login successful! Welcome to your dashboard.', 'success');
                
                e.target.reset();
                authenticatedFingerprint = false;
                authenticatedFingerprintData = null;
                resetLoginFingerprintStatus();
            } catch (error) {
                console.error('Login error:', error);
                showAlert(error.message || 'Login failed. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                document.getElementById('totalStudents').textContent = '...';
                document.getElementById('todayAttendance').textContent = '...';
                document.getElementById('totalAttendance').textContent = '...';

                const [stats, attendance] = await Promise.all([
                    api.get('/dashboard/stats'),
                    api.get('/attendance?limit=10')
                ]);

                document.getElementById('totalStudents').textContent = stats.totalStudents || 0;
                document.getElementById('todayAttendance').textContent = stats.todayAttendance || 0;
                document.getElementById('totalAttendance').textContent = stats.totalAttendance || 0;

                updateAttendanceTable(attendance.attendance || []);
                
                console.log('Dashboard data loaded successfully');
            } catch (error) {
                console.error('Dashboard data loading error:', error);
                showAlert('Failed to load dashboard data: ' + error.message, 'error');
                
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('todayAttendance').textContent = '0';
                document.getElementById('totalAttendance').textContent = '0';
            }
        }

        function updateAttendanceTable(attendanceData) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            if (!attendanceData || attendanceData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #666;">No attendance records found</td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            attendanceData.forEach(record => {
                const row = document.createElement('tr');
                const timestamp = new Date(record.timestamp).toLocaleString();
                
                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${record.user.fullName}</td>
                    <td>${record.user.matricNumber || record.user.staffId || 'N/A'}</td>
                    <td>${record.user.faculty || 'N/A'}</td>
                    <td>${record.user.department || record.user.role || 'N/A'}</td>
                    <td>
                        <span style="color: ${record.action === 'ENTRY' ? 'green' : 'orange'}; font-weight: bold;">
                            ${record.action}
                        </span>
                        ${!record.verified ? ' ⚠️' : ' ✓'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function logout() {
            try {
                if (authToken) {
                    await api.post('/logout');
                }
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                api.clearToken();
                currentUser = null;
                authenticatedFingerprint = false;
                authenticatedFingerprintData = null;
                
                document.getElementById('logoutBtn').style.display = 'none';
                showHome();
                showAlert('Logged out successfully', 'info');
            }
        }

        // Test functions
        async function testAttendanceVerification() {
            try {
                const response = await api.post('/verify-attendance', {
                    rfidCardUID: 'RFID101',
                    fingerprintData: 'student_fingerprint_1',
                    action: 'ENTRY',
                    location: 'Test Building'
                });
                
                console.log('Attendance verification test:', response);
                showAlert(`Attendance verified for ${response.user.fullName}`, 'success');
            } catch (error) {
                console.error('Attendance verification test failed:', error);
                showAlert('Attendance verification failed: ' + error.message, 'error');
            }
        }

        // Alert system
        function showAlert(message, type = 'info') {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application...');
            
            // Check backend connection
            checkBackendConnection();
            
            // Setup form handlers
            document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Start at home page
            showHome();
            
            console.log('Application initialized successfully');
        });
    </script>
</body>
</html>